<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lakota Astro Map</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.84/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.84/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&display=swap');

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: "Poppins", sans-serif;
        }
        header {
            background-color: #f0f0f0;
            padding: 10px 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header nav ul {
            list-style: none;
            display: flex;
            margin: 0;
            padding: 0;
        }
        header nav ul li {
            margin: 0 15px;
            position: relative;
        }
        header nav ul li a {
            text-decoration: none;
            color: #333;
            font-weight: bold;
        }
        header nav ul li ul {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            list-style: none;
            padding: 0;
            margin: 0;
            border-radius: 8px;
        }
        header nav ul li:hover ul {
            display: block;
        }
        header nav ul li ul li {
            padding: 10px;
        }
        header nav ul li ul li a {
            color: #333;
        }
        main {
            padding: 20px;
            text-align: center;
            background-image: url("./background.jpg");
        }
        #infoContainer {
            position: relative;
            width: 80%;
            height: 80vh;
            background-color: #ffebcdab;
            border-radius: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            padding: 20px;
            box-sizing: border-box;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        #content {
            display: flex;
            height: 100%;
            justify-content: space-between;
        }
        #infoPanel {
            width: 38%;
            padding: 25px;
            text-align: left;
            color: black;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        #mapContainer {
            width: 50%;
            height: 95%;
            background-color: #e0e0e0;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        #mapControls {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        #mapControls button {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background-color: whitesmoke;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            cursor: pointer;
            margin: 0 10px;
        }
        #mapControls button:focus {
            outline: none;
        }
        #cesiumContainer {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-title">
            <h1>Lakota Astro Map</h1>
        </div>
        <nav>
            <ul>
                <li><a href="#">Instruction</a>
                    <ul>
                        <li><a href="#">Step 1</a></li>
                        <li><a href="#">Step 2</a></li>
                    </ul>
                </li>
                <li><a href="#">Reading List</a>
                    <ul>
                        <li><a href="#">http://www.kstrom.net/isk/stars/startabs.html#hillsmap</a></li>
                        <li><a href="#">Article 2</a></li>
                    </ul>
                </li>
                <li><a href="#">Blogs</a></li>
                <li><a href="#">Contributors</a></li>
                <li><a href="#">Submit Feedback</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <div id="infoContainer">
            <div id="content">
                <div id="infoPanel">
                    <p id="siteDescription"></p>
                </div>
                <div id="mapContainer">
                    <div id="cesiumContainer"></div>
                </div>
            </div>
            <div id="mapControls">
                <button id="prevSlide">&#8592;</button>
                <button id="nextSlide">&#8594;</button>
            </div>
        </div>
    </main>
    <script type="module">
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI4Y2UxNzZkMy0zNzQ0LTRlNDgtOWNiMS0yMTMyMzRkMDNkM2EiLCJpZCI6MjI3MDAwLCJpYXQiOjE3MjA0MTczNDl9.sgA8iXyS8xJ8GKaarEABWdW7wuHhL6Jp4Yvo0UUqiNc';

        const viewer = new Cesium.Viewer('cesiumContainer', {
            terrainProvider: Cesium.createWorldTerrain(),
            skyAtmosphere: false,
            sceneModePicker: false,
            timeline: true,
            animation: false,
            creditContainer: document.createElement('div'),
            shadows: true
        });

        viewer.scene.globe.enableLighting = true;
        viewer.scene.backgroundColor = Cesium.Color.BLACK;
        viewer.scene.skyBox.show = true;

        let siteIndex = 0, prevSiteIndex = -1;
        let descriptionIndex = 0;

        const sites = await (await fetch('./sites.json')).json();
        console.log('result',sites)

        sites
            .slice(1, -1)
            .forEach((site, index) => {
            const entity = viewer.entities.add({
                name: site.site_name,
                position: Cesium.Cartesian3.fromDegrees(site.longitude, site.latitude, site.altitude),
                point: {
                    pixelSize: 10,
                    color: Cesium.Color.RED,
                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                },
                label: {
                    text: site.site_name,
                    font: '14pt monospace',
                    style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                    outlineWidth: 2,
                    verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                    pixelOffset: new Cesium.Cartesian2(0, -20),
                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                },
                // description: `
                //     <h2>${site.site_name}</h2>
                //     <p>${site.description}</p>
                //     <p><strong>Celestial Body:</strong> ${site.celestial_body}</p>
                //     <p><strong>Tags:</strong> ${site.tags}</p>
                //     <img src="${site.image_url}" alt="${site.site_name}" width="200" />
                // `
            });
        });

        function updateInfoPanel() {
            // if (index < 0 || index >= sites.length) {
            //     console.error('Invalid index for updateInfoPanel:', index);
            //     return;
            // }
            const site = sites[siteIndex];
            document.getElementById('siteDescription').innerHTML = `
                <h2>${site.site_name}</h2>
                <p>${site.descriptions[descriptionIndex]}</p>
                <p><strong>Celestial Body:</strong> ${site.celestial_body}</p>
                <!-- <p><strong>Tags:</strong> ${site.tags}</p> -->
                <img src="${site.image_url}" alt="${site.site_name}" width="200" />
            `;
            if (prevSiteIndex !== siteIndex)
                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(site.longitude, site.latitude-0.02, site.altitude),
                    orientation: {
                        heading: Cesium.Math.toRadians(site.heading || 0),
                        pitch: Cesium.Math.toRadians(site.pitch || -20),
                    }
                });
            prevSiteIndex = siteIndex;
        }

        document.getElementById('prevSlide').addEventListener('click', function() {
            // currentIndex = (currentIndex - 1 + sites.length) % sites.length;
            if (descriptionIndex <= 0) {
                if (siteIndex === 0) return;
                siteIndex--;
                descriptionIndex = sites[siteIndex].descriptions.length;
            }
            descriptionIndex--;
            updateInfoPanel();
        });

        document.getElementById('nextSlide').addEventListener('click', function() {
            descriptionIndex++;
            if (descriptionIndex >= sites[siteIndex].descriptions.length) {
                if (siteIndex === sites.length - 1) return;
                siteIndex++;
                descriptionIndex = 0;
            }
            updateInfoPanel();
        });

        viewer.selectedEntityChanged.addEventListener(function(entity) {
            if (entity) {
                const index = sites.findIndex(site => site.site_name === entity.name);
                siteIndex = index; descriptionIndex = 0;
                updateInfoPanel();
            }
        });

        updateInfoPanel();
    </script>
</body>
</html>
